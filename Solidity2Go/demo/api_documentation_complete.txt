番茄溯源系统API接口完整文档

1. 基础信息
- 服务名称: 番茄溯源系统
- 版本: v1.0
- 协议: HTTP/HTTPS
- 基础URL: http://localhost:8081

2. 核心接口

2.1 查询番茄信息
GET /tomato/:tomato_id

请求参数:
- tomato_id (路径参数): 番茄ID

响应格式:
{
  "base": {
    "TomatoId": "string",
    "ProductionArea": "string",
    "HarvestDate": "big.Int",
    "HarvestEvaluation": "string",
    "Grower": "common.Address"
  },
  "process": {
    "ProcessingDate": "big.Int",
    "SamplingEvaluation": "string",
    "Factory": "common.Address"
  },
  "transport": {
    "TransportInfo": "string",
    "Logistic": "common.Address"
  }
}

说明:
- 当所有字段为空时，对应的地址字段（Grower、Factory、Logistic）也会被设置为空地址
- 地址字段从数据库role表中获取对应角色的地址值
- Grower地址对应"Grower"角色的地址
- Factory地址对应"Factory"角色的地址  
- Logistic地址对应"Logistic"角色的地址

2.2 查询番茄信息（查询参数方式）
GET /query-tomato

请求参数:
- tomato_id (查询参数): 番茄ID

响应格式: 同上

3. 角色管理接口

3.1 注册角色
POST /role/register

功能描述: 注册新的用户角色，生成唯一UID并存储到数据库

请求体 (Content-Type: application/json):
{
  "role_type": "string" // 必填，角色类型，可选值: Consumer/Grower/Logistic/Factory/QualityExpert
}

请求示例:
{
  "role_type": "QualityExpert"
}

成功响应 (200 OK):
{
  "uid": "string",           // 生成的唯一用户ID
  "role_type": "string",      // 注册的角色类型
  "address": "string",        // 对应角色的区块链地址
  "message": "string"         // 成功消息
}

响应示例:
{
  "uid": "2ebee08b-8303-432b-a136-145501c2dd82",
  "role_type": "QualityExpert",
  "address": "0x762267eE97Bb2F1700CDFF8bB849e9ab3b17Bd8D",
  "message": "Role registered successfully in database"
}

错误响应:
- 400 Bad Request: {"error": "Invalid role type"} // 角色类型无效
- 400 Bad Request: {"error": "Private key file not configured for this role"} // 角色私钥未配置
- 500 Internal Server Error: {"error": "Failed to extract address from key file: 错误详情"} // 地址提取失败
- 500 Internal Server Error: {"error": "Failed to save role to database: 错误详情"} // 数据库保存失败

4. 番茄信息管理接口

4.1 添加番茄信息
POST /add-tomato

功能描述: 种植户或工厂添加新的番茄基本信息

请求头:
X-User-UID: string (可选，用户UID)

请求体 (Content-Type: application/json):
{
  "uid": "string",              // 可选，用户UID（也可通过请求头传递）
  "production_area": "string",   // 必填，产地信息
  "harvest_date": "string"       // 必填，收获日期，格式: YYYY-MM-DD
}

请求示例:
{
  "uid": "2ebee08b-8303-432b-a136-145501c2dd82",
  "production_area": "山东寿光",
  "harvest_date": "2024-01-15"
}

成功响应 (200 OK):
{
  "tomato_id": "string",         // 生成的番茄ID
  "message": "string"            // 成功消息
}

响应示例:
{
  "tomato_id": "TOMATO_e8fb3e1a0e31b5dcec343c5a4c05ccd93fadfe0a0e2d101aff1451dfeefad8cc",
  "message": "Tomato information added successfully"
}

错误响应:
- 400 Bad Request: {"error": "参数错误详情"} // 参数验证失败
- 401 Unauthorized: {"error": "User UID required"} // 缺少用户身份
- 403 Forbidden: {"error": "Only Grower or Factory role can add tomato information"} // 权限不足
- 500 Internal Server Error: {"error": "Failed to create transaction options: 错误详情"} // 交易创建失败
- 500 Internal Server Error: {"error": "Failed to add tomato info: 错误详情"} // 添加信息失败

4.2 更新收获信息
POST /tomato/harvest

功能描述: 种植户更新番茄的收获信息

请求头:
X-User-UID: string (可选，用户UID)

请求体 (Content-Type: application/json):
{
  "tomato_id": "string",         // 必填，番茄ID
  "production_area": "string",   // 必填，产地信息
  "harvest_date": "string",      // 必填，收获日期，格式: YYYY-MM-DD
  "uid": "string"                // 可选，用户UID（也可通过请求头传递）
}

成功响应 (200 OK):
{
  "message": "Harvest information updated successfully"
}

错误响应:
- 400 Bad Request: 参数错误
- 401 Unauthorized: 缺少用户身份
- 403 Forbidden: {"error": "只有种植者角色可以更新收获信息"} // 权限不足
- 500 Internal Server Error: 更新失败

4.3 更新运输信息
POST /tomato/transport

功能描述: 物流角色更新番茄运输信息

请求头:
X-User-UID: string (可选)

请求体 (Content-Type: application/json):
{
  "tomato_id": "string",         // 必填，番茄ID
  "transport_info": "string",    // 必填，运输信息
  "uid": "string"                // 可选，用户UID
}

成功响应 (200 OK):
{
  "message": "Transport information updated successfully"
}

错误响应:
- 400 Bad Request: 参数错误
- 401 Unauthorized: 缺少用户身份
- 403 Forbidden: {"error": "只有物流角色可以更新运输信息"} // 权限不足

4.4 更新加工信息
POST /tomato/processing

功能描述: 工厂角色更新番茄加工信息

请求头:
X-User-UID: string (可选)

请求体 (Content-Type: application/json):
{
  "tomato_id": "string",         // 必填，番茄ID
  "processing_date": "string",   // 必填，加工日期，格式: YYYY-MM-DD
  "uid": "string"                // 可选，用户UID
}

成功响应 (200 OK):
{
  "message": "Processing information updated successfully"
}

错误响应:
- 400 Bad Request: 参数错误
- 401 Unauthorized: 缺少用户身份
- 403 Forbidden: {"error": "只有工厂角色可以更新加工信息"} // 权限不足

5. 专家评估接口

5.1 专家评估（V2）
POST /tomato/expert-evaluate

功能描述: 质量专家通过调用Spring Boot图像识别服务进行番茄评估

请求头:
X-User-UID: string (可选，用户UID)

请求体 (Content-Type: application/json):
{
  "tomato_id": "string",         // 必填，番茄ID
  "role": "string",              // 必填，评估类型，可选值: sampling/harvest
  "uid": "string"                // 可选，用户UID（也可通过请求头传递）
}

请求示例:
{
  "tomato_id": "TOMATO_e8fb3e1a0e31b5dcec343c5a4c05ccd93fadfe0a0e2d101aff1451dfeefad8cc",
  "role": "sampling",
  "uid": "2ebee08b-8303-432b-a136-145501c2dd82"
}

成功响应 (200 OK):
直接透传Spring Boot服务的响应内容，通常包含:
{
  "code": "0",                   // 0表示成功
  "data": "评估结果内容",         // 具体的评估结果
  "message": "success"            // 响应消息
}

错误响应:
- 400 Bad Request: {"error": "参数错误详情"} // 参数验证失败
- 400 Bad Request: {"error": "Invalid role parameter. Use 'sampling' or 'harvest'."} // role参数无效
- 401 Unauthorized: {"error": "User UID required"} // 缺少用户身份
- 403 Forbidden: {"error": "只有质量专家角色可以进行评估"} // 权限不足
- 500 Internal Server Error: {"error": "Failed to call Spring Boot service: 错误详情"} // 调用Spring Boot服务失败

6. 数据库角色映射关系

| 角色类型 | 地址值 | 权限说明 |
|---------|--------|----------|
| Consumer | 0x0b35F558d3aD35F5Fc7a430a784A3bC06C8CFF36 | 消费者，可查询信息 |
| Grower | 0x3b6267e282741092A740382Ce0F2E89c6C1e2faB | 种植户，可添加和更新收获信息 |
| Factory | 0xDb8835c5f720B6aaf5ff80C79cf9442C1038a947 | 工厂，可更新加工信息 |
| Logistic | 0x7CC9da5081981A21107a20e30DA23D1529CE266F | 物流，可更新运输信息 |
| QualityExpert | 0x762267eE97Bb2F1700CDFf8bB849e9ab3b17Bd8D | 质量专家，可更新质量评估信息 |

7. 权限控制规则

7.1 角色权限矩阵:
| 操作 | Consumer | Grower | Logistic | Factory | QualityExpert |
|------|----------|--------|----------|---------|---------------|
| 查询番茄信息 | ✓ | ✓ | ✓ | ✓ | ✓ |
| 添加番茄信息 | ✗ | ✓ | ✗ | ✓ | ✗ |
| 更新收获信息 | ✗ | ✓ | ✗ | ✗ | ✗ |
| 更新运输信息 | ✗ | ✗ | ✓ | ✗ | ✗ |
| 更新加工信息 | ✗ | ✗ | ✗ | ✓ | ✗ |
| 更新质量信息 | ✗ | ✗ | ✗ | ✗ | ✓ |
| 专家评估 | ✗ | ✗ | ✗ | ✗ | ✓ |

7.2 权限验证流程:
1. 通过UID从数据库role表查询用户角色
2. 验证用户角色是否具有相应操作权限
3. 如权限不足，返回403 Forbidden错误
4. 权限验证通过后，使用对应角色的私钥进行区块链交易

8. 错误处理

8.1 HTTP状态码说明:
- 200 OK: 请求成功处理
- 400 Bad Request: 请求参数错误或缺失
- 401 Unauthorized: 用户身份验证失败，缺少UID
- 403 Forbidden: 用户权限不足，无权执行该操作
- 404 Not Found: 请求的资源不存在
- 500 Internal Server Error: 服务器内部错误

8.2 错误响应格式:
{
  "error": "string"  // 错误详情描述
}

8.3 常见错误场景:
- 参数验证失败: 返回400状态码
- 用户身份缺失: 返回401状态码
- 权限验证失败: 返回403状态码
- 数据库操作失败: 返回500状态码
- 区块链交易失败: 返回500状态码
- 外部服务调用失败: 返回500状态码

9. 特殊规则

9.1 空值处理规则:
   - 当base结构体中除Grower外的所有字段都为空时，Grower地址设为空
   - 当process结构体中除Factory外的所有字段都为空时，Factory地址设为空  
   - 当transport结构体中除Logistic外的所有字段都为空时，Logistic地址设为空

9.2 数据来源: 
   - 所有查询操作直接从MySQL数据库tomato_info表和role表获取数据
   - 不再调用区块链合约进行查询（提高性能）

9.3 地址赋值规则:
   - Grower、Factory、Logistic字段的地址值从role表中对应角色的address列获取
   - 地址使用标准校验和格式（EIP-55）

9.4 日期格式规范:
   - 输入日期格式: YYYY-MM-DD（如: 2024-01-15）
   - 数据库存储: TIMESTAMP类型
   - 区块链存储: Unix时间戳（bigint）

9.5 UID生成规则:
   - 使用UUID v4算法生成全局唯一标识符
   - 格式: 8-4-4-4-12的36位字符串
   - 示例: 2ebee08b-8303-432b-a136-145501c2dd82

10. 性能优化说明

10.1 数据库查询优化:
   - 使用索引优化常用查询字段
   - 实现连接池复用数据库连接
   - 采用批量操作减少数据库往返次数

10.2 缓存策略:
   - 角色信息缓存到内存中
   - 常用查询结果可考虑Redis缓存
   - 区块链数据定期同步到数据库

10.3 并发处理:
   - 使用Goroutine处理并发请求
   - 数据库操作使用连接池
   - 外部服务调用设置合理的超时时间

11. 安全规范

11.1 身份验证:
   - 所有写操作必须提供有效的UID
   - UID通过数据库role表进行验证
   - 支持请求头和请求体两种传递方式

11.2 权限控制:
   - 基于角色的访问控制（RBAC）
   - 每个操作都有明确的权限要求
   - 权限验证失败立即返回错误

11.3 数据安全:
   - 敏感信息如私钥文件路径不暴露给前端
   - 数据库连接使用参数化查询防止SQL注入
   - 日志记录不包含敏感信息

12. 部署与运维

12.1 环境配置:
   - configs.toml配置文件管理所有环境变量
   - 支持多环境配置（开发/测试/生产）
   - 数据库连接、区块链节点等配置集中管理

12.2 监控与日志:
   - 详细的请求日志记录
   - 错误追踪和报警机制
   - 性能指标监控

12.3 备份与恢复:
   - 定期数据库备份
   - 区块链数据快照
   - 灾难恢复预案